---
title: "Odisha EC Analysis"
author: "Anutubh Agnihotri and Pranav Gupta"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
rm(list=ls())
```


```{r}
library(data.table)
library(sf)
library(tidyverse)
library(cowplot)
library(patchwork)
library(lfe)
library(expss)
library(lubridate)
library(zoo)
library(data.table)
```

## Change Username 

```{r}
user <- "agnihotri"
#user <- "prana"
#user <- "hp"
```

## Loading Files

```{r}
ec_files <- list.files(paste0("C:/Users/",user,"/Dropbox/agnihotri_gupta/Environment_Clearance/Final"))
```

```{r}
ec_main <- NULL

ec_files_main_data<-ec_files[which(grepl("maindata",ec_files))]

for(i in 1:length(ec_files_main_data)){
  add <- read.csv(paste0("C:/Users/",user,"/Dropbox/agnihotri_gupta/Environment_Clearance/Final/",ec_files_main_data[i]))
  add$csv <- i
  ec_main <- dplyr::bind_rows(ec_main,add)
}

table(duplicated(ec_main$Proposal.No.))

ec_main$Proposal<-ec_main$Proposal.No.
ec_main$st_code <- sub("^[^/]*/([^/]*)/.*$", "\\1", ec_main$Proposal.No.)
table(ec_main$st_code)

ec <- ec_main
```

## Adding variables

```{r}
table(ec$st_code)

table(grepl("SIA/CG/", ec$Proposal))

ec <- ec %>%
  mutate(
    state1 = case_when(st_code == 'AP' ~ "Andhra_Pradesh", 
                    st_code =='BR' ~ "Bihar", 
                    st_code =='CG' ~ "Chattisgarh", 
                    st_code =='GJ' ~ "Gujarat",
                    st_code =='HP' ~ "Himachal_Pradesh",
                    st_code =='HR' ~ "Haryana",
                    st_code =='JH' ~ "Jharkhand",
                    st_code =='KA' ~ "Karnataka", 
                    st_code =='KL' ~ "Kerala", 
                    st_code =='MH' ~ "Maharashtra",
                    st_code =='MP' ~ "Madhya_Pradesh",
                    st_code =='OR' ~ "Odisha",
                    st_code =='PB' ~ "Punjab",
                    st_code =='RJ' ~ "Rajasthan",
                    st_code =='TG' ~ "Telangana",  
                    st_code =='UP' ~ "Uttar_Pradesh", 
                    st_code =='WB' ~ "West_Bengal",
                    st_code =='TN' ~ "Tamil_Nadu", 
                    TRUE ~ "Other"))


table(ec$state1)
```

```{r}
ec <- ec %>% filter(state1 != "Other")
```

## Removing Duplication

```{r}
ec <- ec %>% select(Proposal,Proposal.Name,Date_1,Date_2,Category,Status,state1,District,Tehsil) %>% distinct()
ec$duplicate <- duplicated(ec$Proposal)
table(ec$duplicate)
```

## Recoding

```{r}
#Category Simplified 

ec$Category_Simplified <- ifelse(grepl('INFRA',ec$Category),'Infrastructure',
                                    ifelse(grepl('Industrial',ec$Category),'Industrial',
                                    ifelse(ec$Category=='Non-Coal Mining','Non-Coal Mining','Other')))

table(ec$Category_Simplified)

#Status Simplified

ec$Status_Simplified <- ifelse(grepl('EC Granted',ec$Status),'EC Granted',
                                    ifelse(grepl('Delisted',ec$Status),'Delisted',
                                           ifelse(grepl('Rejected',ec$Status),'Rejected',
                                    ifelse(ec$Status=='WithdrawEC','Withdrawn','Other'))))

table(ec$Status_Simplified)

ec$Delisted<-ifelse(ec$Status_Simplified=='Delisted',1,0)
ec$Rejected<-ifelse(ec$Status_Simplified=='Rejected',1,0)
ec$Withdrawn<-ifelse(ec$Status_Simplified=='Withdrawn',1,0)

table(ec$Delisted)

ec%>%
  group_by(state1)%>%
  summarise(Delisted=sum(Delisted),
            Total=n(),
            Percent=Delisted/Total)
```

## Dates

```{r}
extract_after_colon <- function(input) {
  split_string <- strsplit(input, ":")
  extracted_text <- sapply(split_string, function(x) trimws(x[2]))
  return(extracted_text)
}

#For the projects that were delisted or withdrawn 
#Date 2 is when EC was filed
#Date 1 is actually the date on which TOR was submitted
index_with_tor<-which(grepl('TOR',ec$Date_1))

ec$Date_1[index_with_tor]<-ec$Date_2[index_with_tor]

ec$Date_2[index_with_tor]<-"NA"


# Applying the function to the input vector
ec$submit <- extract_after_colon(ec$Date_1) %>% dmy()

sum(is.na(ec$submit))

ec$grant <- extract_after_colon(ec$Date_2) %>% dmy()

sum(is.na(ec$grant))

ec$submit_date <- ifelse(!is.na(ec$submit), ec$submit, ec$grant) %>% as.Date()

table(ec$submit==ec$submit_date)
```

## Time Calculation

```{r}
#Time taken to Grant 
ec$time <- as.duration(ec$grant - ec$submit)/ddays(1)
ec$time2 <- as.numeric(ec$grant - ec$submit_date)
ec$time2[ec$time2<=0] <- NA
summary(ec$time)
summary(ec$time2)

ec$year <- year(ec$submit_date)
table(ec$year)

ec <- ec %>% filter(year>2014)

ec$Sand<-ifelse(grepl('sand',tolower(ec$Proposal.Name)),1,0)
table(ec$Sand)

ec<-ec%>%
  filter(Sand==1)

```

## Election Dates

```{r}
elec <- read.csv(paste0("C:/Users/",user,"/Dropbox/agnihotri_gupta/Environment_Clearance/election_date.csv"))
colnames(elec)[1]='state1'

ec <- left_join(ec,elec,by='state1')
```

```{r}
ec$elec1 <- ymd(ec$elec1)
ec$elec2 <- ymd(ec$elec2)
ec$elec3 <- ymd(ec$elec3)

ec$res1 <- ymd(ec$res1)
ec$res2 <- ymd(ec$res2)
ec$res3 <- ymd(ec$res3)

ec$elecyear1 <- year(ec$res1)
ec$elecyear2 <- year(ec$res2)
ec$elecyear3 <- year(ec$res3)
```

# Electoral Cyles in Submission of Applications

```{r}
#Distance - days/weeks from all elections
ec$submit_diff1 <- as.duration(ec$submit_date - ec$res1)/ddays(1) 
ec$submit_week1 <- as.duration(ec$submit_date - ec$res1)/dweeks(1) 
ec$submit_diff2 <- as.duration(ec$submit_date - ec$res2)/ddays(1) 
ec$submit_week2 <- as.duration(ec$submit_date - ec$res2)/dweeks(1) 
ec$submit_diff3 <- as.duration(ec$submit_date - ec$res3)/ddays(1) 
ec$submit_week3 <- as.duration(ec$submit_date - ec$res3)/dweeks(1) 

summary(ec$submit_diff3)

#Identifying closest election
#Fixed Uttar Pradesh and Himachal Pradesh 
ec$submit_diff_abs <- with(ec,pmin(abs(ec$submit_diff1),abs(ec$submit_diff2),abs(ec$submit_diff3),na.rm = T))

summary(ec$submit_diff_abs)

ec$state1[which(is.na(ec$submit_diff_abs))]


ec <- ec %>% mutate(
  submit_diff = case_when(submit_diff_abs == abs(submit_diff1) ~ submit_diff1,
                         submit_diff_abs == abs(submit_diff2) ~ submit_diff2,
                         submit_diff_abs == abs(submit_diff3) ~ submit_diff3)
  )

summary(ec$submit_diff)


ec$submit_week_abs <- with(ec,pmin(abs(ec$submit_week1),abs(ec$submit_week2),abs(ec$submit_week3),na.rm = T))

summary(ec$submit_week_abs)

ec <- ec %>% mutate(
  submit_week = case_when(submit_week_abs == abs(submit_week1) ~ submit_week1,
                         submit_week_abs == abs(submit_week2) ~ submit_week2,
                         submit_week_abs == abs(submit_week3) ~ submit_week3)
  )

summary(ec$submit_week)

#Round off week
ec$submit_week <- round(ec$submit_week,0)

##Adding election year for the closest delta

ec <- ec %>% mutate(
  elec_date = case_when(submit_week_abs == abs(submit_week1) ~ as.Date(res1),
                         submit_week_abs == abs(submit_week2) ~ as.Date(res2),
                         submit_week_abs == abs(submit_week3) ~ as.Date(res3))
  )

table(ec$elec_date)

##State election

ec$state_elec <- paste0(ec$state1,'.',year(ec$elec_date))

#Identifying Pre-Post
## aa - aren't there two pre posts here because there are two cycles. 
ec$submit_pre <- ifelse(ec$submit_week<0,"Before","After")
```

```{r}
submit_subset <- ec %>% filter(Category_Simplified=='Non-Coal Mining') %>% filter(inrange(submit_week,-100,100)==T) %>% group_by(state1,submit_week,state_elec) %>% summarise(count=n(), delisted=sum(Delisted)) %>% rename(state=state1)

submit_subset<-submit_subset%>%mutate(delisted_percent=delisted/count)

all_weeks = -100:100  # Replace with your actual range of years
#all_states = unique(ec$state1) # Replace with your actual list of states
all_elec <- unique(submit_subset$state_elec) 

submit_cycle <- expand.grid(submit_week = all_weeks, state_elec = all_elec)

submit_cycle <- left_join(submit_cycle,submit_subset,by=c("submit_week","state_elec"))

elec_date <- ec %>% select(state_elec,elec_date) %>% distinct()

submit_cycle <- left_join(submit_cycle,elec_date,by=c("state_elec"))

#State

submit_cycle$state <- sub("\\..*$", "", submit_cycle$state_elec)

# Calculate new dates by adding weeks
submit_cycle$week_date <- submit_cycle$elec_date + weeks(submit_cycle$submit_week)

# Extract the year from the new dates
submit_cycle$submit_year <- year(submit_cycle$week_date)

# Replacing NAs

submit_cycle$count[is.na(submit_cycle$count)] <- 0

summary(submit_cycle$count)

submit_cycle$delisted[is.na(submit_cycle$delisted)] <- 0

summary(submit_cycle$delisted)

submit_cycle$delisted_percent[is.na(submit_cycle$delisted_percent)] <- 0

summary(submit_cycle$delisted_percent)

# Restricting to 2015 onwards

submit_cycle <- submit_cycle %>% filter(submit_year %in% c(2015:2023))
```


```{r}
submit_cycle$tau <- abs(submit_cycle$submit_week+100)

summary(submit_cycle$tau)

submit_cycle$tausq <- abs(submit_cycle$tau)^2
```

# Electoral Cyles in No. of Licenses Granted

```{r}
ec$grant_diff1 <- as.duration(ec$grant - ec$res1)/ddays(1) 
ec$grant_week1 <- as.duration(ec$grant - ec$res1)/dweeks(1) 

ec$grant_diff2 <- as.duration(ec$grant - ec$res2)/ddays(1) 
ec$grant_week2 <- as.duration(ec$grant - ec$res2)/dweeks(1) 

ec$grant_diff3 <- as.duration(ec$grant - ec$res3)/ddays(1) 
ec$grant_week3 <- as.duration(ec$grant - ec$res3)/dweeks(1) 

#Identifying closest election

ec$grant_diff_abs <- with(ec,pmin(abs(ec$grant_diff1),abs(ec$grant_diff2),abs(ec$grant_diff3),na.rm = T))

summary(ec$grant_diff_abs)

ec <- ec %>% mutate(
  grant_diff = case_when(grant_diff_abs == abs(grant_diff1) ~ grant_diff1,  grant_diff_abs == abs(grant_diff2) ~ grant_diff2, grant_diff_abs == abs(grant_diff3) ~ grant_diff3))

summary(ec$grant_diff)

ec$grant_week_abs <- with(ec,pmin(abs(ec$grant_week1),abs(ec$grant_week2),abs(ec$grant_week3),na.rm = T))

summary(ec$grant_week_abs)

ec <- ec %>% mutate(
  grant_week = case_when(grant_week_abs == abs(grant_week1) ~ grant_week1,
                         grant_week_abs == abs(grant_week2) ~ grant_week2,
                         grant_week_abs == abs(grant_week3) ~ grant_week3)
  )

summary(ec$grant_week)

#Round off week
ec$grant_week <- round(ec$grant_week,0)

##Adding election year for the closest delta

ec <- ec %>% mutate(
  elec_date = case_when(grant_week_abs == abs(grant_week1) ~ as.Date(res1),
                         grant_week_abs == abs(grant_week2) ~ as.Date(res2),
                         grant_week_abs == abs(grant_week3) ~ as.Date(res3)))

##State election

ec$state_elec <- paste0(ec$state1,'.',year(ec$elec_date))
```


```{r}
grant_n_subset <- ec %>% filter(Category_Simplified=='Non-Coal Mining') %>% filter(inrange(grant_week,-100,100)==T) %>% group_by(state1,grant_week,state_elec) %>% summarise(count=n()) %>% rename(state=state1)


all_weeks = -100:100  # Replace with your actual range of years
#all_states = unique(ec$state1) # Replace with your actual list of states
all_elec <- unique(submit_subset$state_elec) 

grant_n_cycle <- expand.grid(grant_week = all_weeks, state_elec = all_elec)

grant_n_cycle <- left_join(grant_n_cycle,grant_n_subset,by=c("grant_week","state_elec"))

elec_date <- ec %>% select(state_elec,elec_date) %>% distinct()

grant_n_cycle <- left_join(grant_n_cycle,elec_date,by=c("state_elec"))


#State

grant_n_cycle$state <- sub("\\..*$", "", grant_n_cycle$state_elec)


# Calculate new dates by adding weeks
grant_n_cycle$week_date <- grant_n_cycle$elec_date + weeks(grant_n_cycle$grant_week)

# Extract the year from the new dates
grant_n_cycle$grant_year <- year(grant_n_cycle$week_date)

#Replacing NAs

grant_n_cycle$count[is.na(grant_n_cycle$count)] <- 0

grant_n_cycle$pre <- ifelse(grant_n_cycle$grant_week>0,"Post","Pre")

t.test(grant_n_cycle$count~grant_n_cycle$pre)

grant_n_cycle$tau <- abs(grant_n_cycle$grant_week+100)

summary(grant_n_cycle$tau)

grant_n_cycle$tausq <- abs(grant_n_cycle$tau)^2

grant_n_cycle <- grant_n_cycle %>% filter(grant_year %in% c(2015:2023))
```

# Electoral Cyles in Time Taken for Licenses Granted

```{r}
grant_cycle <- ec %>% filter(inrange(grant_week,-100,100)==T&time>0&Category_Simplified!="Other") 

summary(grant_cycle$time)

grant_cycle$pre <- ifelse(grant_cycle$grant_week>0,"Post","Pre")

t.test(grant_cycle$time~grant_cycle$pre)

grant_cycle$tau <- abs(grant_cycle$grant_week+100)

summary(grant_cycle$tau)

grant_cycle$tausq <- abs(grant_cycle$tau)^2
```

# PBCs in Submission

```{r}
#Distance - days/weeks from all elections
ec$pbc_submit_week1 <- as.duration(ec$submit_date - ec$res1)/dweeks(1) 
ec$pbc_submit_week2 <- as.duration(ec$submit_date - ec$res2)/dweeks(1) 
ec$pbc_submit_week3 <- as.duration(ec$submit_date - ec$res3)/dweeks(1) 

summary(ec$pbc_submit_week3)

#Identifying closest election

ec <- ec %>% mutate(pbc_submit_week = case_when(inrange(pbc_submit_week1,0,270) ~ pbc_submit_week1, inrange(pbc_submit_week2,0,270) ~ pbc_submit_week2, inrange(pbc_submit_week3,0,270) ~ pbc_submit_week3))

summary(ec$pbc_submit_week)

#Round off week
ec$pbc_submit_week <- round(ec$pbc_submit_week,0)

##Adding election year for the closest delta


ec <- ec %>% mutate(elec_date = case_when(inrange(pbc_submit_week1,0,270) ~ as.Date(res1), inrange(pbc_submit_week2,0,270) ~ as.Date(res2), inrange(pbc_submit_week3,0,270) ~ as.Date(res3)))

##State election

ec$state_elec <- paste0(ec$state1,'.',year(ec$elec_date))
```


```{r}
pbc_submit_subset <- ec %>% filter(Category_Simplified=='Non-Coal Mining') %>% group_by(state1,pbc_submit_week,state_elec) %>% summarise(count=n()) %>% rename(state=state1)

all_weeks = 0:270  # Replace with your actual range of years
#all_states = unique(ec$state1) # Replace with your actual list of states
all_elec <- unique(pbc_submit_subset$state_elec) 

pbc_submit_cycle <- expand.grid(pbc_submit_week = all_weeks, state_elec = all_elec)

pbc_submit_cycle <- left_join(pbc_submit_cycle,pbc_submit_subset,by=c("pbc_submit_week","state_elec"))

elec_date <- ec %>% select(state_elec,elec_date) %>% distinct()

pbc_submit_cycle <-left_join(pbc_submit_cycle,elec_date,by=c("state_elec"))

#State

pbc_submit_cycle$state <- sub("\\..*$", "", pbc_submit_cycle$state_elec)

# Calculate new dates by adding weeks
pbc_submit_cycle$week_date <- pbc_submit_cycle$elec_date + weeks(pbc_submit_cycle$pbc_submit_week)

# Extract the year from the new dates
pbc_submit_cycle$submit_year <- year(pbc_submit_cycle$week_date)

# Replacing NAs

pbc_submit_cycle$count[is.na(pbc_submit_cycle$count)] <- 0

summary(pbc_submit_cycle$count)

# Restricting to 2015 onwards
pbc_submit_cycle <- pbc_submit_cycle %>% filter(submit_year %in% c(2015:2024))
```



```{r}
pbc_submit_cycle$tau <- pbc_submit_cycle$pbc_submit_week

summary(pbc_submit_cycle$tau)

pbc_submit_cycle$tausq <- (pbc_submit_cycle$tau)^2

#write.csv(submit_cycle,paste0("C:/Users/",user,"/Desktop/submit.csv"))

```

```{r}
ggplot(pbc_submit_cycle, aes(x=pbc_submit_week, y = count+1)) + 
stat_summary(fun= "mean", geom = "point",color="blue")+
 geom_smooth(method = "loess", se = FALSE,color="red")+
  geom_vline(xintercept = 0,color="black")+ scale_y_log10()+
labs(x = "Weeks to/since Election",y = "No. of applications") +ggtitle("No of Projects Submitted")
```

 
```{r}
mod1 <- felm(count~tau|state+submit_year|0|0,data=pbc_submit_cycle)
summary(mod1)


mod2 <- felm(count~tau+tausq|state+submit_year|0|0,data=pbc_submit_cycle)
summary(mod2)
```

# PBC in No. of Licenses Granted

```{r}
ec$pbc_grant_week1 <- as.duration(ec$grant - ec$res1)/dweeks(1)
ec$pbc_grant_week2 <- as.duration(ec$grant - ec$res2)/dweeks(1)
ec$pbc_grant_week3 <- as.duration(ec$grant - ec$res3)/dweeks(1) 

#Identifying closest election

ec <- ec %>% mutate(pbc_grant_week = case_when(inrange(pbc_grant_week1,0,270) ~ pbc_grant_week1, inrange(pbc_grant_week2,0,270) ~ pbc_grant_week2, inrange(pbc_grant_week3,0,270) ~ pbc_grant_week3))

summary(ec$pbc_grant_week)

#Round off week
ec$pbc_grant_week <- round(ec$pbc_grant_week,0)

##Adding election year for the closest delta

ec <- ec %>% mutate(elec_date = case_when(inrange(pbc_grant_week1,0,270) ~ as.Date(res1), inrange(pbc_grant_week2,0,270) ~ as.Date(res2), inrange(pbc_grant_week3,0,270) ~ as.Date(res3)))


##State election

ec$state_elec <- paste0(ec$state1,'.',year(ec$elec_date))

```


```{r}
pbc_grant_n_subset <- ec %>% filter(Category_Simplified=='Non-Coal Mining') %>%  group_by(state1,pbc_grant_week,state_elec) %>% summarise(count=n()) %>% rename(state=state1)

all_weeks = 0:270  # Replace with your actual range of years
#all_states = unique(ec$state1) # Replace with your actual list of states
all_elec <- unique(submit_subset$state_elec) 

pbc_grant_n_cycle <- expand.grid(pbc_grant_week = all_weeks, state_elec = all_elec)

pbc_grant_n_cycle <- left_join(pbc_grant_n_cycle,pbc_grant_n_subset,by=c("pbc_grant_week","state_elec"))

elec_date <- ec %>% select(state_elec,elec_date) %>% distinct()

pbc_grant_n_cycle <- left_join(pbc_grant_n_cycle,elec_date,by=c("state_elec"))


#State

pbc_grant_n_cycle$state <- sub("\\..*$", "", pbc_grant_n_cycle$state_elec)

# Calculate new dates by adding weeks
pbc_grant_n_cycle$week_date <- pbc_grant_n_cycle$elec_date + weeks(pbc_grant_n_cycle$pbc_grant_week)


# Extract the year from the new dates
pbc_grant_n_cycle$grant_year <- year(pbc_grant_n_cycle$week_date)

#Replacing NAs

pbc_grant_n_cycle$count[is.na(pbc_grant_n_cycle$count)] <- 0

pbc_grant_n_cycle$tau <- pbc_grant_n_cycle$pbc_grant_week

summary(pbc_grant_n_cycle$tau)

pbc_grant_n_cycle$tausq <- abs(pbc_grant_n_cycle$tau)^2

```


## PBC in Time Taken


```{r}
obc_grant_cycle <- ec %>% filter(inrange(grant_week,-100,100)==T&time>0&Category_Simplified!="Other") 

summary(grant_cycle$time)

grant_cycle$pre <- ifelse(grant_cycle$grant_week>0,"Post","Pre")

t.test(grant_cycle$time~grant_cycle$pre)

grant_cycle$tau <- abs(grant_cycle$grant_week+100)

summary(grant_cycle$tau)

grant_cycle$tausq <- abs(grant_cycle$tau)^2
```





```{r}
#mod1 <- summary(lm(count~tau+tausq,data=submit_cycle))
mod1 <- felm(count~tau+tausq|state+grant_year|0|0,data=pbc_grant_n_cycle)
summary(mod1)
```



```{r}
ggplot(submit_cycle, aes(x=submit_week, y = delisted_percent)) + 
stat_summary(fun= "mean", geom = "point",color="blue")+
 geom_smooth(method = "lm", formula = y ~ poly(x, 2), se = FALSE,color="red")+
  geom_vline(xintercept = 0,color="black")+
labs(x = "Weeks to/since Election",y = "No. of applications") +ggtitle("Percent of Projects Delisted")

ggsave(paste0("C:/Users/",user,"/Dropbox/agnihotri_gupta/Environment_Clearance/Environmental_Clearance_Paper_Ideas/Figures/submit_delisted_percent_elec_cycle_sand.png"))

ggplot(submit_cycle, aes(x=submit_week, y = delisted)) + 
stat_summary(fun= "mean", geom = "point",color="blue")+
 geom_smooth(method = "lm", formula = y ~ poly(x, 2), se = FALSE,color="red")+
  geom_vline(xintercept = 0,color="black")+ scale_y_log10()+
labs(x = "Weeks to/since Election",y = "No. of applications") +ggtitle("No of Projects Delisted")

ggsave(paste0("C:/Users/",user,"/Dropbox/agnihotri_gupta/Environment_Clearance/Environmental_Clearance_Paper_Ideas/Figures/submit_delisted_count_elec_cycle_sand.png"))

ggplot(submit_cycle, aes(x=submit_week, y = count)) + 
stat_summary(fun= "mean", geom = "point",color="blue")+
 geom_smooth(method = "loess", se = FALSE,color="red")+
  geom_vline(xintercept = 0,color="black")+ scale_y_log10()+
labs(x = "Weeks to/since Election",y = "No. of applications") +ggtitle("No of Projects Submitted")

ggsave(paste0("C:/Users/",user,"/Dropbox/agnihotri_gupta/Environment_Clearance/Environmental_Clearance_Paper_Ideas/Figures/submit_count_elec_cycle_sand.png"))
```
```{r}
mod1 <- felm(count~tau|state+submit_year|0|0,data=submit_cycle)
summary(mod1)
mod2 <- felm(count~tau+tausq|state+submit_year|0|0,data=submit_cycle)
summary(mod2)
```

```{r}
mod1_50 <- felm(count~tau|state|0|0,data=filter(submit_cycle,submit_week>-51&submit_week<51))
summary(mod1_50)
mod2_50 <- felm(count~tau+tausq|state|0|0,data=filter(submit_cycle,submit_week>-51&submit_week<51))
summary(mod2_50)
```


```{r}
mod1_delisted <- felm(delisted~tau|state|0|0,data=submit_cycle)
summary(mod1_delisted)
mod2_delisted <- felm(delisted~tau+tausq|state|0|0,data=submit_cycle)
summary(mod2_delisted)
```


```{r}
mod1_delisted_50 <- felm(delisted~tau|state|0|0,data=filter(submit_cycle,submit_week>-51&submit_week<51))
summary(mod1_delisted_50)

mod2_delisted_50 <- felm(delisted~tau+tausq|state|0|0,data=filter(submit_cycle,submit_week>-51&submit_week<51))
summary(mod2_delisted_50)
```


```{r}
mod1 <- felm(delisted_percent~tau|state|0|0,data=submit_cycle)
summary(mod1)

mod2 <- felm(delisted_percent~tau+tausq|state|0|0,data=submit_cycle)
summary(mod2)
```


```{r}
#mod1 <- summary(lm(count~tau+tausq,data=submit_cycle))
mod1 <- felm(count~tau+tausq|state+grant_year|0|0,data=grant_n_cycle)
summary(mod1)

grant_n_cycle$Post<-ifelse(grant_n_cycle$pre=="Post",1,0)

mod2 <- felm(count~grant_week*Post|state+grant_year|0|0,data=grant_n_cycle)
summary(mod2)
```

```{r}
ggplot(grant_n_cycle, aes(x=grant_week, y = count)) + 
stat_summary(fun= "mean", geom = "point",color="blue")+
 geom_smooth(method = "lm", formula = y ~ poly(x, 2), se = FALSE,color="red")+
  geom_vline(xintercept = 0,color="black")+
labs(x = "Weeks to/since Election",y = "No. of applications") 


grant_n_cycle %>% 
  ggplot(aes(x = grant_week, y = count)) + 
  geom_point() + scale_y_log10()+
  geom_vline(xintercept = 0, color = "red", size = 1, linetype = "dashed") + 
  annotate("text", x = 20.4, y = 105, label = "Election Date",
           size=4) +
  labs(y = "Count",
       x = "Time to Elections")+facet_wrap(~state)
```


```{r}
mod1 <- felm(log(1+time)~tau+tausq|year+state1|0|0,data=grant_cycle)

summary(mod1)

mod2 <- felm(log(1+time)~tau+tausq|year+state1|0|0,data=grant_cycle,subset = Category_Simplified== "Non-Coal Mining")
summary(mod2)
```



```{r}
ggplot(grant_cycle, aes(x=grant_week, y = time)) + 
stat_summary(fun= "mean", geom = "point",color="blue")+
 geom_smooth(method = "lm", formula = y ~ poly(x, 2), se = T,color="red")+
  geom_vline(xintercept = 0,color="black")+
labs(x = "Weeks to/since Election",y = "Time") + facet_wrap(~Category_Simplified)
```



#See Pre-Post Lag Lead Changes


```{r absent-cancel-ptime}

pbc_submit_cycle$pbc_submit_qtr<-pbc_submit_cycle$pbc_submit_week/12
pbc_submit_cycle$pbc_submit_qtr<-round(pbc_submit_cycle$pbc_submit_qtr,0)

pbc_submit_cycle <- pbc_submit_cycle %>%
  mutate(
    time_til=pbc_submit_qtr,
    lead0 = case_when(time_til == 0 ~ 1, TRUE ~ 0),
    lead1 = case_when(time_til == 1 ~ 1, TRUE ~ 0),
    lead2 = case_when(time_til == 2 ~ 1, TRUE ~ 0),
    lead3 = case_when(time_til == 3 ~ 1, TRUE ~ 0),
    lead4 = case_when(time_til == 4 ~ 1, TRUE ~ 0),
    lead5 = case_when(time_til == 5 ~ 1, TRUE ~ 0),
    lead6 = case_when(time_til == 6 ~ 1, TRUE ~ 0),
     lead7 = case_when(time_til == 7 ~ 1, TRUE ~ 0),
    lead8 = case_when(time_til == 8 ~ 1, TRUE ~ 0),
    lead9 = case_when(time_til == 9 ~ 1, TRUE ~ 0),
     lead10 = case_when(time_til == 10 ~ 1, TRUE ~ 0),
    lead11 = case_when(time_til == 11 ~ 1, TRUE ~ 0),
    lead12 = case_when(time_til == 12 ~ 1, TRUE ~ 0),
     lead13 = case_when(time_til == 13 ~ 1, TRUE ~ 0),
    lead14 = case_when(time_til == 14 ~ 1, TRUE ~ 0),
    lead15 = case_when(time_til == 15 ~ 1, TRUE ~ 0),
    lead16 = case_when(time_til == 16 ~ 1, TRUE ~ 0),
     lead17 = case_when(time_til == 17 ~ 1, TRUE ~ 0),
    lead18 = case_when(time_til == 18 ~ 1, TRUE ~ 0),
    lead19 = case_when(time_til == 19 ~ 1, TRUE ~ 0),
     lead20 = case_when(time_til == 20 ~ 1, TRUE ~ 0),
    lead21 = case_when(time_til == 21 ~ 1, TRUE ~ 0),
    lead22 = case_when(time_til == 22 ~ 1, TRUE ~ 0)
    
  )

event_study_formula <- as.formula(
  paste("log(1+count) ~ ",
        paste(
          paste(paste("lead", 1:22, sep = ""), collapse = " + ")),
        "|state+submit_year| 0 | 0"
  ),
)

event_study_submit_cycle<- felm(event_study_formula, data =pbc_submit_cycle)


summary(event_study_submit_cycle)

plot_order <- c( "lead1", 
                "lead2", "lead3",
                "lead4", "lead5",
                "lead6", "lead7",
                "lead8",
                "lead9", "lead10",
                "lead11", "lead12",
                 "lead13",
                "lead14", "lead15",
                "lead16", "lead17",
                "lead18", "lead19",
                "lead20", "lead21",
                "lead22")

# order of the coefficients for the plot
leadslags_plot <- tibble(
  sd = c(event_study_submit_cycle$se[plot_order]),
  mean = c(coef(event_study_submit_cycle)[plot_order]),
  label = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22))



# This version has a point-range at each
# estimated lead or lag
# comes down to stylistic preference at the
# end of the day!
leadslags_plot %>%
  ggplot(aes(x = label, y = mean,
             ymin = mean-1.96*sd, 
             ymax = mean+1.96*sd)) +
  geom_hline(yintercept = 0, color = "red") +
  geom_pointrange() +
  theme_minimal() +
  xlab("Lead 1 to 22") +
  ylab("count") +
  geom_hline(yintercept = 0,
             linetype = "dashed") +
  geom_vline(xintercept = 0,
             linetype = "dashed")


# This version includes
# an interval that traces the confidence intervals
# of your coefficients
leadslags_plot %>%
  ggplot(aes(x = label, y = mean,
             ymin = mean-1.96*sd, 
             ymax = mean+1.96*sd)) +
  # this creates a red horizontal line
  geom_hline(yintercept = 0, color = "red") +
  geom_line() + 
  geom_point() +
  geom_ribbon(alpha = 0.2) +
  theme_minimal() +
  # Important to have informative axes labels!
  xlab("Present to Absent") +
  ylab("N") +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0)
```

#################################

```{r absent-cancel-ptime}

submit_cycle$submit_qtr<-submit_cycle$submit_week/12
submit_cycle$submit_qtr<-round(submit_cycle$submit_qtr,0)

submit_cycle <- submit_cycle %>%
  mutate(
    time_til=submit_qtr,
    lead0 = case_when(time_til == 0 ~ 1, TRUE ~ 0),
    lead1 = case_when(time_til == 1 ~ 1, TRUE ~ 0),
    lead2 = case_when(time_til == 2 ~ 1, TRUE ~ 0),
    lead3 = case_when(time_til == 3 ~ 1, TRUE ~ 0),
    lead4 = case_when(time_til == 4 ~ 1, TRUE ~ 0),
    lead5 = case_when(time_til == 5 ~ 1, TRUE ~ 0),
    lead6 = case_when(time_til == 6 ~ 1, TRUE ~ 0),
     lead7 = case_when(time_til == 7 ~ 1, TRUE ~ 0),
    lead8 = case_when(time_til == 8 ~ 1, TRUE ~ 0),
    lag1 = case_when(time_til == -1 ~ 1, TRUE ~ 0),
     lag2 = case_when(time_til == -2 ~ 1, TRUE ~ 0),
    lag3 = case_when(time_til == -3 ~ 1, TRUE ~ 0),
    lag4 = case_when(time_til == -4 ~ 1, TRUE ~ 0),
     lag5 = case_when(time_til == -5 ~ 1, TRUE ~ 0),
    lag6 = case_when(time_til == -6 ~ 1, TRUE ~ 0),
    lag7 = case_when(time_til == -7 ~ 1, TRUE ~ 0),
    lag8 = case_when(time_til == -8 ~ 1, TRUE ~ 0),
  )

event_study_formula <- as.formula(
  paste("count ~ ",
        paste(
          paste(paste("lead", 1:8, sep = ""), collapse = " + "),
          paste(paste("lag", 1:8, sep = ""), collapse = " + "), sep = " + "),
        "|state+submit_year| 0 | 0"),
)


event_study_submit_cycle<- felm(event_study_formula, data =submit_cycle)


summary(event_study_submit_cycle)

plot_order <- c( "lead1", 
                "lead2", "lead3",
                "lead4", "lead5",
                "lead6", "lead7",
                "lead8",
                "lag1", "lag2",
                "lag3", "lag4",
                 "lag5",
                "lag6", "lag7",
                "lag8")

# order of the coefficients for the plot
leadslags_plot <- tibble(
  sd = c(event_study_submit_cycle$se[plot_order]),
  mean = c(coef(event_study_submit_cycle)[plot_order]),
  label = c(-8,-7,-6,-5,-4,-3,-2,-1,1,2,3,4,5,6,7,8))



# This version has a point-range at each
# estimated lead or lag
# comes down to stylistic preference at the
# end of the day!
leadslags_plot %>%
  ggplot(aes(x = label, y = mean,
             ymin = mean-1.96*sd, 
             ymax = mean+1.96*sd)) +
  geom_hline(yintercept = 0, color = "red") +
  geom_pointrange() +
  theme_minimal() +
  xlab("Lag/Lead") +
  ylab("count") +
  geom_hline(yintercept = 0,
             linetype = "dashed") +
  geom_vline(xintercept = 0,
             linetype = "dashed")


# This version includes
# an interval that traces the confidence intervals
# of your coefficients
leadslags_plot %>%
  ggplot(aes(x = label, y = mean,
             ymin = mean-1.96*sd, 
             ymax = mean+1.96*sd)) +
  # this creates a red horizontal line
  geom_hline(yintercept = 0, color = "red") +
  geom_line() + 
  geom_point() +
  geom_ribbon(alpha = 0.2) +
  theme_minimal() +
  # Important to have informative axes labels!
  xlab("Present to Absent") +
  ylab("N") +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0)
```


#############################

#See Pre-Post Lag Lead Changes


```{r absent-cancel-ptime}

pbc_grant_n_cycle$pbc_grant_qtr<-pbc_grant_n_cycle$pbc_grant_week/12

pbc_grant_n_cycle$pbc_grant_qtr<-round(pbc_grant_n_cycle$pbc_grant_qtr,0)

pbc_grant_n_cycle <- pbc_grant_n_cycle %>%
  mutate(
    time_til=pbc_grant_qtr,
    lead0 = case_when(time_til == 0 ~ 1, TRUE ~ 0),
    lead1 = case_when(time_til == 1 ~ 1, TRUE ~ 0),
    lead2 = case_when(time_til == 2 ~ 1, TRUE ~ 0),
    lead3 = case_when(time_til == 3 ~ 1, TRUE ~ 0),
    lead4 = case_when(time_til == 4 ~ 1, TRUE ~ 0),
    lead5 = case_when(time_til == 5 ~ 1, TRUE ~ 0),
    lead6 = case_when(time_til == 6 ~ 1, TRUE ~ 0),
     lead7 = case_when(time_til == 7 ~ 1, TRUE ~ 0),
    lead8 = case_when(time_til == 8 ~ 1, TRUE ~ 0),
    lead9 = case_when(time_til == 9 ~ 1, TRUE ~ 0),
     lead10 = case_when(time_til == 10 ~ 1, TRUE ~ 0),
    lead11 = case_when(time_til == 11 ~ 1, TRUE ~ 0),
    lead12 = case_when(time_til == 12 ~ 1, TRUE ~ 0),
     lead13 = case_when(time_til == 13 ~ 1, TRUE ~ 0),
    lead14 = case_when(time_til == 14 ~ 1, TRUE ~ 0),
    lead15 = case_when(time_til == 15 ~ 1, TRUE ~ 0),
    lead16 = case_when(time_til == 16 ~ 1, TRUE ~ 0),
     lead17 = case_when(time_til == 17 ~ 1, TRUE ~ 0),
    lead18 = case_when(time_til == 18 ~ 1, TRUE ~ 0),
    lead19 = case_when(time_til == 19 ~ 1, TRUE ~ 0),
     lead20 = case_when(time_til == 20 ~ 1, TRUE ~ 0),
    lead21 = case_when(time_til == 21 ~ 1, TRUE ~ 0),
    lead22 = case_when(time_til == 22 ~ 1, TRUE ~ 0)
    
  )

event_study_formula <- as.formula(
  paste("log(1+count) ~ ",
        paste(
          paste(paste("lead", 1:22, sep = ""), collapse = " + ")),
        "|state+grant_year| 0 | 0"
  ),
)

event_study_grant_cycle<- felm(event_study_formula, data =pbc_grant_n_cycle)


summary(event_study_grant_cycle)

plot_order <- c( "lead1", 
                "lead2", "lead3",
                "lead4", "lead5",
                "lead6", "lead7",
                "lead8",
                "lead9", "lead10",
                "lead11", "lead12",
                 "lead13",
                "lead14", "lead15",
                "lead16", "lead17",
                "lead18", "lead19",
                "lead20", "lead21",
                "lead22")

# order of the coefficients for the plot
leadslags_plot <- tibble(
  sd = c(event_study_grant_cycle$se[plot_order]),
  mean = c(coef(event_study_grant_cycle)[plot_order]),
  label = c(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22))



# This version has a point-range at each
# estimated lead or lag
# comes down to stylistic preference at the
# end of the day!
leadslags_plot %>%
  ggplot(aes(x = label, y = mean,
             ymin = mean-1.96*sd, 
             ymax = mean+1.96*sd)) +
  geom_hline(yintercept = 0, color = "red") +
  geom_pointrange() +
  theme_minimal() +
  xlab("Lead 1 to 22") +
  ylab("count") +
  geom_hline(yintercept = 0,
             linetype = "dashed") +
  geom_vline(xintercept = 0,
             linetype = "dashed")


# This version includes
# an interval that traces the confidence intervals
# of your coefficients
leadslags_plot %>%
  ggplot(aes(x = label, y = mean,
             ymin = mean-1.96*sd, 
             ymax = mean+1.96*sd)) +
  # this creates a red horizontal line
  geom_hline(yintercept = 0, color = "red") +
  geom_line() + 
  geom_point() +
  geom_ribbon(alpha = 0.2) +
  theme_minimal() +
  # Important to have informative axes labels!
  xlab("Present to Absent") +
  ylab("N") +
  geom_hline(yintercept = 0) +
  geom_vline(xintercept = 0)
```