---
title: "Environment"
author: "Pranav Gupta"
date: "`r Sys.Date()`"
output:
  html_document:
    df_print: paged
---

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
rm(list=ls())
```


```{r}
library(sf)
library(tidyverse)
library(cowplot)
library(patchwork)
library(lfe)
library(expss)
library(lubridate)
library(zoo)
```

```{r}
user <- "prana"
#user <- "anust"

```

```{r}
ec_odisha <- read.csv(paste0("C:/Users/",user,"/Dropbox/agnihotri_gupta/Environment_Clearance/Orissa/Orissa_ec_additional_data.csv")) %>% distinct()

tor_odisha <- read.csv(paste0("C:/Users/",user,"/Dropbox/agnihotri_gupta/Environment_Clearance/Orissa/Orissa_tor_additional_data.csv")) %>% distinct()


table(tor_odisha$Proposal%in%ec_odisha$Proposal)
table(ec_odisha$Proposal%in%tor_odisha$Proposal)

tor_ec_common_odisha<-tor_odisha%>%
  filter(Proposal%in%ec_odisha$Proposal)


ec_haryana <- read.csv(paste0("C:/Users/",user,"/Dropbox/agnihotri_gupta/Environment_Clearance/Haryana/Haryana_ec_additional_data.csv")) %>% distinct()

tor_haryana <- read.csv(paste0("C:/Users/",user,"/Dropbox/agnihotri_gupta/Environment_Clearance/Haryana/Haryana_tor_additional_data.csv")) %>% distinct()

table(tor_haryana$Proposal%in%ec_haryana$Proposal)
table(ec_haryana$Proposal%in%tor_haryana$Proposal)

tor_ec_common_haryana<-tor_haryana%>%
  filter(Proposal%in%ec_haryana$Proposal)


```

```{r}
ec_files <- list.files(paste0("C:/Users/",user,"/Dropbox/agnihotri_gupta/Environment_Clearance/Final"))
```


```{r}
ec <- NULL
for(i in 1:length(ec_files)){
  add <- read.csv(paste0("C:/Users/",user,"/Dropbox/agnihotri_gupta/Environment_Clearance/Final/",ec_files[i]))
  ec <- rbind(ec,add)
}

ec <- ec %>% filter(State %in% c("Haryana","Orissa","Uttar Pradesh"))

tor <- rbind(tor_odisha,tor_haryana) %>% filter(State %in% c("Haryana","Orissa"))

```

```{r}
table(ec$Status)
```

## Build
```{r}
grant_ec <- ec %>% filter(Status %in% c("EC Granted","EC Granted - Processed offline")) %>% distinct()

grant_tor<-tor%>%
  filter(grepl('TOR Granted',Status))

```

```{r}
grant_ec$duplicate <- duplicated(grant_ec$Proposal)
table(grant_ec$duplicate)


grant_tor$duplicate <- duplicated(grant_tor$Proposal)
table(grant_tor$duplicate)

```

##Simplify the Categories of Projects 

```{r}
grant_tor$Category_Simplified <- ifelse(grepl('INFRA',grant_tor$Category),'INFRA',
                                    ifelse(grepl('Industrial',grant_tor$Category),'Industrial',
                                    ifelse(grant_tor$Category=='Non-Coal Mining','Non-Coal Mining','Other')))

table(grant_tor$Category_Simplified)


```

##Simplify the Categories of Projects 

```{r}
grant_ec$Category_Simplified <- ifelse(grepl('INFRA',grant_ec$Category),'INFRA',
                                    ifelse(grepl('Industrial',grant_ec$Category),'Industrial',
                                    ifelse(grant_ec$Category=='Non-Coal Mining','Non-Coal Mining','Other')))

table(grant_ec$Category_Simplified)

```

```{r}
extract_after_colon <- function(input) {
  split_string <- strsplit(input, ":")
  extracted_text <- sapply(split_string, function(x) trimws(x[2]))
  return(extracted_text)
}

# Applying the function to the input vector
grant_ec$submit <- extract_after_colon(grant_ec$Date_1) %>% dmy()
grant_ec$grant <- extract_after_colon(grant_ec$Date_2) %>% dmy()

#Time taken to Grant 
grant_ec$time <- as.duration(grant_ec$grant - grant_ec$submit)/ddays(1)


# Applying the function to the input vector
grant_tor$submit <- extract_after_colon(grant_tor$Date_1) %>% dmy()
grant_tor$grant <- extract_after_colon(grant_tor$Date_2) %>% dmy()

#Time taken to Grant 
grant_tor$time <- as.duration(grant_tor$grant - grant_tor$submit)/ddays(1)


```


```{r}
summary(grant_ec$time)

#Exclude if length  less than 0

grant_ec <- grant_ec %>% filter(time >=0) #Some obs have negative grant time

grant_tor <- grant_tor %>% filter(time >=0) #Some obs have negative grant time

```


```{r extract-year}
#Year of Submission
grant_ec$submit_year<-(gsub('^([0-9][0-9][0-9][0-9]).*','\\1',grant_ec$submit))
grant_ec$submit_year <- year(grant_ec$submit)

#Year-Month of Submission
grant_ec$submit_year_mon<-as.yearmon(grant_ec$submit)

#Year of Submission
grant_tor$submit_year<-(gsub('^([0-9][0-9][0-9][0-9]).*','\\1',grant_tor$submit))
#Year-Month of Submission
grant_tor$submit_year_mon<-as.yearmon(grant_tor$submit)

```


```{r}
density_year <- ggplot(grant_ec, aes(x = submit_year)) +
  geom_bar() +
  theme_minimal() + facet_wrap(~State) + ggtitle('EC Granted')

print(density_year)
```

```{r}
density_year <- ggplot(grant_tor, aes(x = submit_year)) +
  geom_bar() +
  theme_minimal() + facet_wrap(~State) + ggtitle('TOR Granted')

print(density_year)
```

```{r}
density_year_tor <- ggplot(grant_tor, aes(x = submit_year)) +
  geom_bar() +
  theme_minimal() + ggtitle('TOR') + facet_wrap(~State)

print(density_year_tor)
```

## Descriptives

```{r}
table(tor$Status)
```

```{r}
density_year_non_coal_mining <- ggplot(filter(grant_ec,Category=='Non-Coal Mining'), aes(x = submit_year)) +
  geom_bar(fill = "skyblue", color = "darkblue", alpha = 0.5) +
  theme_minimal() + facet_wrap(~State) + ggtitle('Non Coal Mining Projects (EC)') 

print(density_year_non_coal_mining)
```

```{r}
density_year_infra <- ggplot(filter(grant_ec,grepl('INFRA',Category)), aes(x = submit_year)) +
  geom_bar(fill = "skyblue", color = "darkblue", alpha = 0.5) +
  theme_minimal() + facet_wrap(~State) + ggtitle('INFRA Projects') 

print(density_year_infra)
```


```{r}
density_ec_all_odisha <- ggplot(filter(grant_ec,State=='Orissa'), aes(x = submit_year)) +
  geom_bar(fill = "skyblue", color = "darkblue", alpha = 0.5) +
  theme_minimal() + facet_wrap(~Category_Simplified) + ggtitle('ODISHA Projects (EC)') 

print(density_ec_all_odisha)
```

```{r}
density_year_non_coal_mining_tor <- ggplot(filter(grant_tor,Category=='Non-Coal Mining'), aes(x = submit_year)) +
  geom_bar(fill = "skyblue", color = "darkblue", alpha = 0.5) +
  theme_minimal() + facet_wrap(~State) + ggtitle('Non Coal Mining Projects (TOR)') 

print(density_year_non_coal_mining_tor)
```


```{r}
density_tor_all_odisha <- ggplot(filter(grant_tor,State=='Orissa'), aes(x = submit_year)) +
  geom_bar(fill = "skyblue", color = "darkblue", alpha = 0.5) +
  theme_minimal() + facet_wrap(~Category_Simplified) + ggtitle('ODISHA Projects (TOR)') 

print(density_tor_all_odisha)
```


```{r}
density_year_infra_orissa <- ggplot(filter(grant_ec,State=='Orissa'), aes(x = submit_year_mon, y = time)) +geom_vline(xintercept = as.yearmon('May 2019'), linetype="dashed", 
             color = "black", size=1)+
  geom_point(fill = "skyblue", color = "darkblue", alpha = 0.5) + scale_x_yearmon()+
  theme_minimal() + ggtitle('Odisha Projects Around Elections (EC)')  +facet_wrap(~Category_Simplified)

print(density_year_infra_orissa)
```


```{r}
density_year_tor_orissa <- ggplot(grant_tor_odisha, aes(x = submit_year_mon, y = time)) +geom_vline(xintercept = as.yearmon('May 2019'), linetype="dashed", 
             color = "black", size=1)+
  geom_point(fill = "skyblue", color = "darkblue", alpha = 0.5) + scale_x_yearmon()+
  theme_minimal() + ggtitle('Odisha Projects Around Elections (TOR)')  +facet_wrap(~Category_Simplified)

print(density_year_tor_orissa)
```

```{r}
density_year_infra_haryana <- ggplot(filter(grant_ec,State=='Haryana'), aes(x = submit_year_mon, y = time)) +geom_vline(xintercept = as.yearmon('Oct 2019'), linetype="dashed", 
             color = "black", size=1)+
  geom_point(fill = "skyblue", color = "darkblue", alpha = 0.5) + scale_x_yearmon()+
  theme_minimal() + ggtitle('Haryana Projects Around Elections')  +facet_wrap(~Category_Simplified)

print(density_year_infra_haryana)
```


```{r}
density_time <- ggplot(grant, aes(x = time)) +
  geom_density(fill = "skyblue", color = "darkblue", alpha = 0.5) +
  theme_minimal()

print(density_time)
```

```{r}
ggplot(grant, aes(x = Category)) +
  geom_bar(aes(y = (..count..)/sum(..count..)), fill = "skyblue", color = "darkblue") +
  labs(x = "Category", y = "Percentage", title = "Category - EC granted") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

```{r}
ggplot(grant, aes(x = Category, y = time)) +
  geom_boxplot(fill = "skyblue", color = "darkblue", outlier.shape = NA) +
  labs(x = "Group", y = "Value", title = "Box Plot") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

```{r}
type <- grant_ec %>% group_by(Category,State) %>% summarise(avg = mean(time),sd = sd(time), count = n())
type$cd <- type$sd/type$avg
```

#District Analysis 

## Build

```{r}
dist <- grant %>% group_by(District,State) %>% summarise(avg = mean(time),sd = sd(time), count = n(),most = names(table(Category))[which.max(table(Category))])
dist$cd <- dist$sd/dist$avg
```

```{r}
code <- read.csv(paste0("C:/Users/",user,"/Dropbox/agnihotri_gupta/Environment_Clearance/district_lgd.csv"))
dist <- full_join(dist,code,by="District")
```


```{r}
dist_or <- dist %>% filter(State=="Orissa") 
dist_har <- dist %>% filter(State=="Haryana")
```


```{r}
# Shape file
dist_shp <- st_read(paste0("C:/Users/",user,"/Dropbox/agnihotri_gupta/Environment_Clearance/Shape_India/DISTRICT_BOUNDARY.shp"))

dist_shp$lgd <- as.numeric(dist_shp$DISTRICT_L)

shp_har <- dist_shp %>% filter(State_LGD==6)
shp_or <- dist_shp %>% filter(State_LGD==21)
```

```{r}
shp_or <- left_join(shp_or,dist_or,by="lgd")
shp_har <- left_join(shp_har,dist_har,by="lgd")
```

## Maps Odisha

```{r}
time_or <- ggplot(shp_or)+
geom_sf(aes(fill = avg)) +
## custom gradient 
scale_fill_gradientn(colors = rcartocolor::carto_pal(name = "BluYl", n =7),limits=c(60,250))+## clean map theme from cowplot
theme_map()+
labs(title = "Avg Time - Odisha", fill = "Days")+ theme(plot.title = element_text(hjust = .5))

print(time_or)
```

```{r}
count_or <- ggplot(shp_or)+
geom_sf(aes(fill = count)) +
## custom gradient 
scale_fill_gradientn(colors = rcartocolor::carto_pal(name = "BluYl", n =7),limits=c(0,200))+## clean map theme from cowplot
theme_map()+
labs(title = "No. of Projects - Odisha", fill = "Count")+ theme(plot.title = element_text(hjust = .5))

print(count_or)
```


```{r}
cd_or <- ggplot(shp_or)+
geom_sf(aes(fill = cd)) +
## custom gradient 
scale_fill_gradientn(colors = rcartocolor::carto_pal(name = "BluYl", n =7),limits=c(0,1.5))+## clean map theme from cowplot
theme_map()+
labs(title = "Coeff. of Dev. - Odisha", fill = "CD")+ theme(plot.title = element_text(hjust = .5))

print(cd_or)
```

```{r}
most_or <- ggplot(shp_or)+
geom_sf(aes(fill = most)) +
## custom gradient 
scale_fill_manual(values = c("red", "blue", "green", "orange","skyblue"), na.value = "grey") +## clean map theme from cowplot
theme_map()+
labs(title = "Categories - Odisha", fill = "CD")+ theme(plot.title = element_text(hjust = .5))

print(most_or)
```

## Maps - Haryana

```{r}
time_har <- ggplot(shp_har)+
geom_sf(aes(fill = avg)) +
## custom gradient 
scale_fill_gradientn(colors = rcartocolor::carto_pal(name = "BluYl", n =7),limits=c(80,999))+## clean map theme from cowplot
theme_map()+
labs(title = "Avg Time - Haryana", fill = "Days")+ theme(plot.title = element_text(hjust = .5))

print(time_har)
```

```{r}
count_har <- ggplot(shp_har)+
geom_sf(aes(fill = count)) +
## custom gradient 
scale_fill_gradientn(colors = rcartocolor::carto_pal(name = "BluYl", n =7),limits=c(1,270))+## clean map theme from cowplot
theme_map()+
labs(title = "No. of Projects - Haryana", fill = "Count")+ theme(plot.title = element_text(hjust = .5))

print(count_har)
```


```{r}
cd_har <- ggplot(shp_har)+
geom_sf(aes(fill = cd)) +
## custom gradient 
scale_fill_gradientn(colors = rcartocolor::carto_pal(name = "BluYl", n =7),limits=c(0,1.5))+## clean map theme from cowplot
theme_map()+
labs(title = "Coeff. of Dev. - Haryana", fill = "CD")+ theme(plot.title = element_text(hjust = .5))

print(cd_har)
```

```{r}
most_har <- ggplot(shp_har)+
geom_sf(aes(fill = most)) +
## custom gradient 
scale_fill_manual(values = c("red", "blue", "green", "orange","skyblue"), na.value = "grey") +## clean map theme from cowplot
theme_map()+
labs(title = "Categories - Haryana", fill = "CD")+ theme(plot.title = element_text(hjust = .5))

print(most_har)
```











